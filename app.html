<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI | By ConnectSphere</title>
    <link rel="icon" type="image/jpeg" href="Gemini_Generated_Image_s0b7rzs0b7rzs0b7.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="Gemini_Generated_Image_s0b7rzs0b7rzs0b7.png">
    <link rel="apple-touch-icon" href="Gemini_Generated_Image_s0b7rzs0b7rzs0b7.png">
    <link rel="shortcut icon" href="Gemini_Generated_Image_s0b7rzs0b7rzs0b7.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tgtnevrd43");
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #4A5568; border-radius: 20px; }
        .sidebar::-webkit-scrollbar { display: none; }
        .sidebar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Professional Styles */
        .glass-pane { background-color: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .main-gradient-text { background: linear-gradient(to right, #a855f7, #6366f1); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background: linear-gradient(to right, #8b5cf6, #6366f1); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        .message-content pre { all: revert; white-space: pre-wrap; font-family: inherit; }
        .message-content code { font-family: 'Courier New', Courier, monospace; background-color: rgba(0,0,0,0.3); padding: 0.1em 0.3em; border-radius: 4px; }
        .message-content pre > code { padding: 1rem; display: block; overflow-x: auto; background-color: #1e293b; border-radius: 0.5rem; }
        .pulsing-dot { animation: pulse 1.4s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .mic-listening { color: #a855f7; animation: pulse-mic 1.5s infinite; }
        @keyframes pulse-mic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 flex justify-center items-center h-screen p-0 md:p-4">

    <!-- App Container -->
    <div id="app" class="w-full h-full bg-slate-900 md:rounded-2xl shadow-2xl flex overflow-hidden relative">
        <!-- Authentication Container -->
        <div id="auth-container" class="w-full h-full flex flex-col justify-center items-center p-4">
            <div class="w-full max-w-md glass-pane p-8 rounded-2xl">
                <h1 class="text-4xl font-extrabold text-center main-gradient-text mb-2">Nexus AI</h1>
                <p class="text-center text-slate-400 mb-8">Crafted by ConnectSphere</p>
                
                <form id="email-password-form" class="space-y-4">
                    <input type="email" id="email" placeholder="Email" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" required>
                    <input type="password" id="password" placeholder="Password (min. 6 characters)" class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" required>
                    <button type="submit" id="email-signin-btn" class="w-full btn-primary text-white font-bold py-3 rounded-lg transition-all duration-300">Sign In</button>
                    <button type="button" id="email-signup-btn" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg transition-all duration-300">Create Account</button>
                </form>

                <div class="my-6 flex items-center">
                    <hr class="w-full border-slate-700">
                    <span class="px-4 text-slate-500 text-sm">OR</span>
                    <hr class="w-full border-slate-700">
                </div>
                
                <button id="google-signin-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-3 rounded-lg flex items-center justify-center hover:bg-white transition-all duration-300">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l8.35 6.52C12.91 13.46 18.06 9.5 24 9.5z"></path><path fill="#34A853" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 5.65-5.71 9.74-12.8 9.74-7.56 0-13.67-6.11-13.67-13.67s6.11-13.67 13.67-13.67c4.17 0 7.48 1.83 9.24 3.52l6.45-6.45C35.13 5.4 29.8 3 24 3 11.98 3 2.13 11.2 2.13 23.5S11.98 44 24 44c11.38 0 20.3-8.08 21.32-18.45l1.66-1z"></path></svg>
                    Continue with Google
                </button>
                <p id="auth-error" class="text-red-500 text-center mt-4 text-sm"></p>
            </div>
        </div>

        <!-- Main Chat Container -->
        <div id="chat-container" class="hidden h-full flex w-full relative">
            <!-- Sidebar Backdrop (for mobile) -->
            <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>
            
            <!-- Sidebar -->
            <div id="sidebar-container" class="bg-slate-900 border-r border-slate-700/50 w-full md:w-1/4 max-w-xs flex-col p-4 overflow-y-auto absolute md:static z-30 h-full -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="flex items-center justify-between mb-4">
                     <h2 class="text-xl font-bold main-gradient-text">Nexus AI Chats</h2>
                     <button id="close-sidebar-btn" class="md:hidden text-slate-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                     </button>
                </div>
                <button id="new-chat-btn" class="w-full btn-primary text-white font-bold py-2.5 px-4 rounded-lg mb-4 transition-all duration-300 flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    <span>New Chat</span>
                </button>
                <div class="flex-grow sidebar">
                    <ul id="chat-list" class="space-y-2"></ul>
                </div>
                <button id="sign-out-btn" class="w-full mt-4 bg-slate-700 hover:bg-red-600/50 text-slate-300 hover:text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">Sign Out</button>
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col bg-slate-900 overflow-hidden">
                <!-- Chat Header -->
                <div class="p-4 border-b border-slate-700/50 flex items-center justify-between flex-shrink-0">
                    <button id="open-sidebar-btn" class="md:hidden text-slate-400 hover:text-white mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <div id="model-selector-container" class="relative">
                         <select id="model-selector" class="bg-slate-800 border border-slate-700 rounded-md py-2 pl-3 pr-8 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none">
                            <option value="pro">Nexus Pro</option>
                            <option value="fast">Nexus Fast</option>
                        </select>
                         <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400">
                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                     <p id="model-description" class="text-xs text-slate-400 ml-4 hidden md:block">Expert model for coding & in-depth tasks.</p>
                </div>
                
                <div id="message-container" class="flex-1 p-6 overflow-y-auto chat-container">
                    <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                        <div class="w-20 h-20 rounded-full mb-6 bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-200">Welcome to Nexus AI</h1>
                        <p class="text-slate-400 mt-2 max-w-md">Start a new conversation or select one from the sidebar. Here are some ideas:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6 text-sm">
                            <div class="bg-slate-800 p-3 rounded-lg text-left">"Write a Python script for a simple web scraper"</div>
                            <div class="bg-slate-800 p-3 rounded-lg text-left">"Explain the concept of quantum computing"</div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-slate-900 border-t border-slate-700/50 flex-shrink-0">
                    <form id="chat-form" class="flex items-center space-x-3 relative">
                        <input type="text" id="message-input" placeholder="Ask Nexus AI... or click the mic to speak" class="w-full pl-4 pr-12 py-3 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" autocomplete="off">
                        <button type="button" id="mic-btn" class="absolute right-14 top-1/2 -translate-y-1/2 text-slate-400 hover:text-purple-400 transition-colors p-2">
                            <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93V17h-2v-2.07A5.002 5.002 0 015 10V8h2v2a3 3 0 006 0V8h2v2a5.002 5.002 0 01-4 4.93z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="submit" class="btn-primary text-white font-bold p-3 rounded-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Loading/Connecting Screen -->
        <div id="loading-container" class="hidden absolute inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center">
            <svg class="animate-spin h-10 w-10 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-slate-400">Connecting...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase config (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyDyQplLKnpFOQlW7_eZ_-FFqozxNd0hwXI",
            authDomain: "ai-project-a1efd.firebaseapp.com",
            projectId: "ai-project-a1efd",
            storageBucket: "ai-project-a1efd.firebasestorage.app",
            messagingSenderId: "17864553119",
            appId: "1:17864553119:web:0e93bc601af77d20ee28aa",
            measurementId: "G-N3QEEY84YF"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const authContainer = document.getElementById('auth-container');
        const chatContainer = document.getElementById('chat-container');
        const loadingContainer = document.getElementById('loading-container');
        const messageContainer = document.getElementById('message-container');
        const chatList = document.getElementById('chat-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const messageInput = document.getElementById('message-input');
        const modelSelector = document.getElementById('model-selector');
        const modelDescription = document.getElementById('model-description');
        
        // State variables
        let currentUserId = null;
        let activeChatId = null;
        let messagesUnsubscribe = null;
        let chatsUnsubscribe = null;
        let currentMessages = [];
        let isInitialChatsLoaded = false;
        let isStreaming = false;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                authContainer.classList.add('hidden');
                loadingContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                isInitialChatsLoaded = false;
                loadUserChats(currentUserId);
            } else {
                currentUserId = null; activeChatId = null;
                authContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                loadingContainer.classList.add('hidden');
                if (messagesUnsubscribe) messagesUnsubscribe();
                if (chatsUnsubscribe) chatsUnsubscribe();
                chatList.innerHTML = ''; messageContainer.innerHTML = '';
                if(welcomeScreen) {
                    messageContainer.appendChild(welcomeScreen);
                    welcomeScreen.style.display = 'flex';
                }
                currentMessages = [];
            }
        });
        
        // --- RESPONSIVE SIDEBAR ---
        const sidebarContainer = document.getElementById('sidebar-container');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        function openSidebar() { sidebarContainer.classList.remove('-translate-x-full'); sidebarBackdrop.classList.remove('hidden'); }
        function closeSidebar() { sidebarContainer.classList.add('-translate-x-full'); sidebarBackdrop.classList.add('hidden'); }
        document.getElementById('open-sidebar-btn').addEventListener('click', openSidebar);
        document.getElementById('close-sidebar-btn').addEventListener('click', closeSidebar);
        sidebarBackdrop.addEventListener('click', closeSidebar);


        // --- CHAT FUNCTIONALITY ---
        function loadUserChats(userId) {
            if (chatsUnsubscribe) chatsUnsubscribe();
            const chatsRef = collection(db, 'users', userId, 'chats');
            const q = query(chatsRef, orderBy('createdAt', 'desc'));
            
            chatsUnsubscribe = onSnapshot(q, (snapshot) => {
                if (!isInitialChatsLoaded) {
                    loadingContainer.classList.add('hidden');
                    chatContainer.classList.remove('hidden');
                    isInitialChatsLoaded = true;
                }
                
                const currentActiveChatId = activeChatId;
                chatList.innerHTML = '';
                snapshot.forEach(doc => {
                    const chat = doc.data();
                    const li = document.createElement('li');
                    li.className = `p-3 rounded-lg cursor-pointer hover:bg-slate-600/50 transition-colors text-sm font-medium ${currentActiveChatId === doc.id ? 'bg-purple-600/50 text-white' : 'text-slate-300'}`;
                    li.textContent = chat.title || 'New Chat';
                    li.dataset.chatId = doc.id;
                    li.addEventListener('click', () => {
                        setActiveChat(doc.id);
                        if (window.innerWidth < 768) { closeSidebar(); }
                    });
                    chatList.appendChild(li);
                });
            });
        }
        
        function setActiveChat(chatId) {
             if (activeChatId === chatId) return;
            activeChatId = chatId;
            document.querySelectorAll('#chat-list li').forEach(li => {
                const isActive = li.dataset.chatId === chatId;
                li.classList.toggle('bg-purple-600/50', isActive);
                li.classList.toggle('text-white', isActive);
                li.classList.toggle('text-slate-300', !isActive);
            });
            loadChatMessages(currentUserId, chatId);
        }

        function loadChatMessages(userId, chatId) {
            if (messagesUnsubscribe) messagesUnsubscribe();
            const messagesRef = collection(db, 'users', userId, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('createdAt'));

            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                if (isStreaming) return; // Prevent re-rendering during stream to avoid duplication

                if(welcomeScreen.parentElement) welcomeScreen.remove();
                messageContainer.innerHTML = '';
                currentMessages = [];
                snapshot.forEach(doc => {
                    const message = doc.data();
                    renderMessage(message.role, message.content);
                    currentMessages.push({ role: message.role, content: message.content });
                });
            });
        }
        
        // --- MODEL SELECTOR ---
        const modelDescriptions = {
            pro: 'Expert model for coding & in-depth tasks.',
            fast: 'Quick and efficient for general conversation.'
        };
        modelSelector.addEventListener('change', (e) => {
            modelDescription.textContent = modelDescriptions[e.target.value];
        });

        // --- SEND MESSAGE LOGIC ---
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const input = form.querySelector('#message-input');
            const submitButton = form.querySelector('button[type="submit"]');
            const messageText = input.value.trim();
            if (!messageText || submitButton.disabled) return;

            input.disabled = true;
            submitButton.disabled = true;
            input.value = '';

            let chatIdToUse = activeChatId;

            // Optimistically render the user message for immediate feedback
            renderMessage('user', messageText);
            currentMessages.push({ role: 'user', content: messageText });

            if (!chatIdToUse) {
                const newChatRef = await addDoc(collection(db, 'users', currentUserId, 'chats'), {
                    title: messageText.substring(0, 40) + (messageText.length > 40 ? '...' : ''),
                    createdAt: serverTimestamp()
                });
                chatIdToUse = newChatRef.id;
                setActiveChat(chatIdToUse);
            }
            
            const messagesRef = collection(db, 'users', currentUserId, 'chats', chatIdToUse, 'messages');
            addDoc(messagesRef, { role: 'user', content: messageText, createdAt: serverTimestamp() });
            
            isStreaming = true;
            const { contentDiv } = createAssistantMessageBubble();
            let fullResponse = "";
            let isFirstChunk = true;

            try {
                const selectedModel = modelSelector.value;
                const messageHistoryForApi = [...currentMessages];

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messageHistoryForApi, model: selectedModel })
                });

                if (!response.body) throw new Error("Streaming not supported.");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (line.trim().startsWith('data:')) {
                            const jsonStr = line.substring(5).trim();
                            if (jsonStr) {
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    if (parsed.text) {
                                        if (isFirstChunk) {
                                            contentDiv.innerHTML = ''; // Clear animation on first text
                                            isFirstChunk = false;
                                        }
                                        fullResponse += parsed.text;
                                        contentDiv.innerHTML = marked.parse(fullResponse + '<span class="blinking-cursor">‚ñç</span>');
                                        messageContainer.scrollTop = messageContainer.scrollHeight;
                                    } else if (parsed.error) {
                                        throw new Error(parsed.error);
                                    }
                                } catch (e) { console.error("Stream parse error:", jsonStr); }
                            }
                        }
                    }
                }
                
                if (fullResponse) {
                    await addDoc(messagesRef, { role: 'assistant', content: fullResponse, createdAt: serverTimestamp() });
                } else {
                    document.getElementById('streaming-bubble')?.remove();
                }

            } catch (error) {
                console.error("Streaming Error:", error);
                const errorMessage = `Sorry, an error occurred: ${error.message}`;
                contentDiv.innerHTML = marked.parse(errorMessage);
                if (fullResponse === "") { 
                    await addDoc(messagesRef, { role: 'assistant', content: errorMessage, createdAt: serverTimestamp() });
                }
            } finally {
                isStreaming = false;
                input.disabled = false;
                submitButton.disabled = false;
                input.focus();
                contentDiv.querySelector('.blinking-cursor')?.remove();
            }
        });

        // --- RENDER & UTILITY FUNCTIONS ---
        function renderMessage(role, content) {
            const messageId = `msg-${Date.now()}-${Math.random()}`;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message flex items-start gap-3 w-full max-w-2xl mb-6 ${role === 'user' ? 'ml-auto flex-row-reverse' : 'mr-auto'}`;
            messageDiv.id = messageId;
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm ${role === 'user' ? 'bg-purple-600' : 'bg-slate-700'}`;
            avatar.textContent = role === 'user' ? 'U' : 'N';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble p-4 rounded-xl shadow-md w-fit max-w-full relative ${role === 'user' ? 'bg-purple-600' : 'bg-slate-700'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content text-slate-200';
            contentDiv.innerHTML = marked.parse(content);
            
            messageBubble.appendChild(contentDiv);

            if (role === 'assistant' && content.trim() !== '') {
                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-btn absolute -bottom-3 right-2 text-slate-500 hover:text-purple-400 transition-colors';
                speakBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
                messageBubble.appendChild(speakBtn);
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageBubble);
            messageContainer.appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
        
        function createAssistantMessageBubble() {
            if(welcomeScreen.parentElement) welcomeScreen.remove();
            const messageDiv = document.createElement('div');
            messageDiv.id = 'streaming-bubble'; 
            messageDiv.className = 'message flex items-start gap-3 w-full max-w-2xl mb-6 mr-auto';
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full flex-shrink-0 bg-slate-700 flex items-center justify-center font-bold text-sm';
            avatar.textContent = 'N';
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble p-4 rounded-xl shadow-md w-fit max-w-full bg-slate-700';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content text-slate-200';
            contentDiv.innerHTML = `<div class="flex items-center justify-center space-x-1">
                                        <div class="w-2 h-2 bg-slate-400 rounded-full pulsing-dot" style="animation-delay: 0s;"></div>
                                        <div class="w-2 h-2 bg-slate-400 rounded-full pulsing-dot" style="animation-delay: 0.2s;"></div>
                                        <div class="w-2 h-2 bg-slate-400 rounded-full pulsing-dot" style="animation-delay: 0.4s;"></div>
                                    </div>`;
            messageBubble.appendChild(contentDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageBubble);
            messageContainer.appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
            return { messageBubble: messageDiv, contentDiv: contentDiv };
        }

        // --- SPEECH-TO-TEXT ---
        const micBtn = document.getElementById('mic-btn');
        const micIcon = document.getElementById('mic-icon');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'en-US'; recognition.interimResults = false;
            recognition.onstart = () => { micIcon.classList.add('mic-listening'); messageInput.placeholder = 'Listening...'; };
            recognition.onend = () => { micIcon.classList.remove('mic-listening'); messageInput.placeholder = 'Ask Nexus AI...'; };
            recognition.onerror = (e) => console.error('STT Error:', e.error);
            recognition.onresult = (e) => { messageInput.value = e.results[0][0].transcript; document.getElementById('chat-form').requestSubmit(); };
            micBtn.addEventListener('click', () => { try { recognition.start(); } catch(e) { console.error("STT Start Error:", e); } });
        } else {
            micBtn.style.display = 'none';
        }

        // --- TEXT-TO-SPEECH (Browser API) ---
        const synth = window.speechSynthesis;
        let voices = [];
        function populateVoiceList() { if(typeof synth === 'undefined') return; voices = synth.getVoices(); }
        populateVoiceList();
        if (typeof synth !== 'undefined' && synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoiceList;
        messageContainer.addEventListener('click', (e) => {
            const speakBtn = e.target.closest('.speak-btn');
            if (!speakBtn) return;
            const messageContent = speakBtn.closest('.message-bubble').querySelector('.message-content').innerText;
            if (!messageContent) return;
            if (synth.speaking) synth.cancel();
            const utterance = new SpeechSynthesisUtterance(messageContent);
            utterance.voice = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang === 'en-US');
            utterance.onend = () => speakBtn.classList.remove('text-purple-400');
            speakBtn.classList.add('text-purple-400');
            synth.speak(utterance);
        });
        
        // --- UNCHANGED AUTH SNIPPETS ---
        document.getElementById('google-signin-btn').addEventListener('click', async () => {const provider = new GoogleAuthProvider();try {await signInWithPopup(auth, provider);} catch (error) {document.getElementById('auth-error').textContent = error.message;}});
        document.getElementById('email-password-form').addEventListener('submit', async (e) => {e.preventDefault();const email = document.getElementById('email').value;const password = document.getElementById('password').value;try {if (e.submitter?.id === 'email-signin-btn') await signInWithEmailAndPassword(auth, email, password);} catch (error) {document.getElementById('auth-error').textContent = error.message;}});
        document.getElementById('email-signup-btn').addEventListener('click', async () => {const email = document.getElementById('email').value;const password = document.getElementById('password').value;try {await createUserWithEmailAndPassword(auth, email, password);} catch (error) {document.getElementById('auth-error').textContent = error.message;}});
        document.getElementById('new-chat-btn').addEventListener('click', async () => {if (!currentUserId) return; activeChatId=null; currentMessages=[]; messageContainer.innerHTML = ''; if (welcomeScreen) { messageContainer.appendChild(welcomeScreen); welcomeScreen.style.display = 'flex'; } messageInput.focus(); });
    </script>
</body>
</html>









